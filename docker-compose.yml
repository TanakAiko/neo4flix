# docker-compose.yml
# Neo4flix Microservices
# Prerequisites: Neo4j and Keycloak must already be running (on user-service_default network)
# Usage: docker-compose up -d --build

services:
  # ===========================================
  # APPLICATION SERVICES
  # ===========================================

  # API Gateway - Entry point for all requests
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: neo4flix-api-gateway
    environment:
      GATEWAY_PORT: "8085"
      # Connect to Keycloak using its container name on the shared network
      KEYCLOAK_ISSUER_URI: http://user-service-keycloak-1:8080/realms/neo4flix
      KEYCLOAK_JWK_SET_URI: http://user-service-keycloak-1:8080/realms/neo4flix/protocol/openid-connect/certs
      # Internal service URLs (container names on same network)
      USER_SERVICE_URL: http://neo4flix-user-service:8081
      MOVIE_SERVICE_URL: http://neo4flix-movie-service:8082
      RATING_SERVICE_URL: http://neo4flix-rating-service:8083
      RECOMMENDATION_SERVICE_URL: http://neo4flix-recommendation-service:8084
    ports:
      - "8085:8085"
    depends_on:
      user-service:
        condition: service_healthy
      movie-service:
        condition: service_healthy
      rating-service:
        condition: service_healthy
      recommendation-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - user-service_default

  # User Service
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: neo4flix-user-service
    environment:
      # Connect to Neo4j using its container name
      NEO4J_URI: bolt://user-service-neo4j-1:7687
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      # Connect to Keycloak using its container name
      KEYCLOAK_ISSUER_URI: http://user-service-keycloak-1:8080/realms/neo4flix
      KEYCLOAK_JWK_SET_URI: http://user-service-keycloak-1:8080/realms/neo4flix/protocol/openid-connect/certs
      KEYCLOAK_ADMIN_USERNAME: ${KEYCLOAK_ADMIN_USER:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASS:-admin}
      KEYCLOAK_SERVER_URL: http://user-service-keycloak-1:8080
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
    # No external ports - only accessible via api-gateway
    expose:
      - "8081"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - user-service_default

  # Movie Service
  movie-service:
    build:
      context: ./movie-service
      dockerfile: Dockerfile
    container_name: neo4flix-movie-service
    environment:
      NEO4J_URI: bolt://user-service-neo4j-1:7687
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      KEYCLOAK_ISSUER_URI: http://user-service-keycloak-1:8080/realms/neo4flix
      TMDB_API_KEY: ${TMDB_API_KEY}
      TMDB_READ_ACCESS_TOKEN: ${TMDB_READ_ACCESS_TOKEN}
    # No external ports - only accessible via api-gateway
    expose:
      - "8082"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - user-service_default

  # Rating Service
  rating-service:
    build:
      context: ./rating-service
      dockerfile: Dockerfile
    container_name: neo4flix-rating-service
    environment:
      NEO4J_URI: bolt://user-service-neo4j-1:7687
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      KEYCLOAK_ISSUER_URI: http://user-service-keycloak-1:8080/realms/neo4flix
    # No external ports - only accessible via api-gateway
    expose:
      - "8083"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - user-service_default

  # Recommendation Service
  recommendation-service:
    build:
      context: ./recommendation-service
      dockerfile: Dockerfile
    container_name: neo4flix-recommendation-service
    environment:
      NEO4J_URI: bolt://user-service-neo4j-1:7687
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      KEYCLOAK_ISSUER_URI: http://user-service-keycloak-1:8080/realms/neo4flix
    # No external ports - only accessible via api-gateway
    expose:
      - "8084"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - user-service_default

# Use the existing network where Neo4j and Keycloak are running
networks:
  user-service_default:
    external: true
